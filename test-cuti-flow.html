<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cuti Flow - Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-form { display: grid; gap: 10px; max-width: 400px; }
        .test-form input, .test-form select, .test-form textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .info { border-left: 4px solid #17a2b8; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { color: #555; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª Test Cuti Flow - Debugging Tools</h1>
        
        <div class="grid">
            <!-- Test 1: Check Jenis Cuti API -->
            <div class="section">
                <h2>1. Test Jenis Cuti API (Current Year)</h2>
                <p>Test endpoint untuk mendapatkan jenis cuti tahun ini</p>
                <button onclick="testJenisCutiAPI()">Test /api/jenis-cuti/active</button>
                <div id="jenis-cuti-result" class="result"></div>
            </div>

            <!-- Test 2: Check PegawaiCuti Quota -->
            <div class="section">
                <h2>2. Test Pegawai Cuti Quota</h2>
                <div class="test-form">
                    <label>Pegawai ID:</label>
                    <input type="number" id="pegawai-id-quota" value="16" min="1">
                    <button onclick="testPegawaiCutiQuota()">Test Quota untuk Pegawai</button>
                </div>
                <div id="pegawai-quota-result" class="result"></div>
            </div>

            <!-- Test 3: Submit Cuti -->
            <div class="section">
                <h2>3. Test Submit Cuti</h2>
                <div class="test-form">
                    <label>Pegawai ID:</label>
                    <input type="number" id="submit-pegawai-id" value="16" min="1">
                    
                    <label>Tanggal Dari:</label>
                    <input type="date" id="tanggal-dari" value="2025-02-01">
                    
                    <label>Tanggal Ke:</label>
                    <input type="date" id="tanggal-ke" value="2025-02-03">
                    
                    <label>Jenis Cuti ID:</label>
                    <input type="number" id="jenis-cuti-id" value="1" min="1">
                    
                    <label>Alasan Cuti:</label>
                    <textarea id="alasan-cuti" rows="3">Test pengajuan cuti untuk debugging sistem</textarea>
                    
                    <button onclick="testSubmitCuti()">Submit Cuti</button>
                </div>
                <div id="submit-cuti-result" class="result"></div>
            </div>

            <!-- Test 4: Check Cuti History -->
            <div class="section">
                <h2>4. Test Cuti History</h2>
                <div class="test-form">
                    <label>Pegawai ID:</label>
                    <input type="number" id="history-pegawai-id" value="16" min="1">
                    <button onclick="testCutiHistory()">Check History</button>
                </div>
                <div id="cuti-history-result" class="result"></div>
            </div>

            <!-- Test 5: Check Admin Cuti List -->
            <div class="section">
                <h2>5. Test Admin Cuti List</h2>
                <p>Cek apakah cuti muncul di admin panel</p>
                <button onclick="testAdminCutiList()">Test Admin Cuti List</button>
                <div id="admin-cuti-result" class="result"></div>
            </div>

            <!-- Test 6: Check Database Records -->
            <div class="section">
                <h2>6. Test Database Records</h2>
                <p>Debug database dengan SQL query</p>
                <button onclick="testDatabaseRecords()">Check Database</button>
                <div id="database-result" class="result"></div>
            </div>

            <!-- Test 7: Check Current Year Settings -->
            <div class="section">
                <h2>7. Test Current Year Settings</h2>
                <div class="test-form">
                    <label>Pegawai ID:</label>
                    <input type="number" id="year-pegawai-id" value="16" min="1">
                    <button onclick="testCurrentYearSettings()">Check Year Settings</button>
                </div>
                <div id="year-settings-result" class="result"></div>
            </div>

            <!-- Test 8: Full Flow Test -->
            <div class="section">
                <h2>8. Full Flow Test</h2>
                <p>Test complete flow dari jenis cuti â†’ submit â†’ history â†’ admin view</p>
                <div class="test-form">
                    <label>Pegawai ID:</label>
                    <input type="number" id="flow-pegawai-id" value="16" min="1">
                    <button onclick="testFullFlow()">Run Full Flow Test</button>
                </div>
                <div id="full-flow-result" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8080';
        
        function logResult(elementId, data, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const url = `${BACKEND_URL}/${endpoint.startsWith('/') ? endpoint.slice(1) : endpoint}`;
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.text();
                let parsedData;
                try {
                    parsedData = JSON.parse(data);
                } catch (e) {
                    parsedData = data;
                }
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data: parsedData
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: error.message
                };
            }
        }

        async function testJenisCutiAPI() {
            logResult('jenis-cuti-result', 'Testing jenis cuti API...', 'info');
            
            const result = await apiCall('api/jenis-cuti/active');
            
            if (result.ok) {
                logResult('jenis-cuti-result', 
                    `âœ… SUCCESS: Found ${result.data.length} jenis cuti\n\n${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
            } else {
                logResult('jenis-cuti-result', 
                    `âŒ ERROR: ${result.status}\n${JSON.stringify(result.data, null, 2)}`, 
                    'error'
                );
            }
        }

        async function testPegawaiCutiQuota() {
            const pegawaiId = document.getElementById('pegawai-id-quota').value;
            logResult('pegawai-quota-result', `Testing quota for pegawai ${pegawaiId}...`, 'info');
            
            const result = await apiCall(`api/pegawai-cuti-quota/${pegawaiId}`);
            
            if (result.ok) {
                logResult('pegawai-quota-result', 
                    `âœ… SUCCESS: Quota found\n\n${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
            } else {
                logResult('pegawai-quota-result', 
                    `âŒ ERROR: ${result.status}\n${JSON.stringify(result.data, null, 2)}`, 
                    'error'
                );
            }
        }

        async function testSubmitCuti() {
            const pegawaiId = document.getElementById('submit-pegawai-id').value;
            const tanggalDari = document.getElementById('tanggal-dari').value;
            const tanggalKe = document.getElementById('tanggal-ke').value;
            const jenisCutiId = document.getElementById('jenis-cuti-id').value;
            const alasanCuti = document.getElementById('alasan-cuti').value;
            
            logResult('submit-cuti-result', 'Submitting cuti...', 'info');
            
            const formData = new FormData();
            formData.append('pegawaiId', pegawaiId);
            formData.append('tanggalDari', tanggalDari);
            formData.append('tanggalKe', tanggalKe);
            formData.append('jenisCuti', jenisCutiId);
            formData.append('alasanCuti', alasanCuti);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/cuti/ajukan`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.text();
                let parsedData;
                try {
                    parsedData = JSON.parse(data);
                } catch (e) {
                    parsedData = data;
                }
                
                if (response.ok) {
                    logResult('submit-cuti-result', 
                        `âœ… SUCCESS: Cuti submitted\n\n${JSON.stringify(parsedData, null, 2)}`, 
                        'success'
                    );
                } else {
                    logResult('submit-cuti-result', 
                        `âŒ ERROR: ${response.status}\n${parsedData}`, 
                        'error'
                    );
                }
            } catch (error) {
                logResult('submit-cuti-result', `âŒ ERROR: ${error.message}`, 'error');
            }
        }

        async function testCutiHistory() {
            const pegawaiId = document.getElementById('history-pegawai-id').value;
            logResult('cuti-history-result', `Getting history for pegawai ${pegawaiId}...`, 'info');
            
            const result = await apiCall(`api/cuti/pegawai/${pegawaiId}?page=0&size=10`);
            
            if (result.ok) {
                logResult('cuti-history-result', 
                    `âœ… SUCCESS: Found ${result.data.totalElements || 0} cuti records\n\n${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
            } else {
                logResult('cuti-history-result', 
                    `âŒ ERROR: ${result.status}\n${JSON.stringify(result.data, null, 2)}`, 
                    'error'
                );
            }
        }

        async function testAdminCutiList() {
            logResult('admin-cuti-result', 'Getting admin cuti list...', 'info');
            
            const result = await apiCall('api/cuti?page=0&size=10');
            
            if (result.ok) {
                logResult('admin-cuti-result', 
                    `âœ… SUCCESS: Found ${result.data.totalElements || 0} total cuti records\n\n${JSON.stringify(result.data, null, 2)}`, 
                    'success'
                );
            } else {
                logResult('admin-cuti-result', 
                    `âŒ ERROR: ${result.status}\n${JSON.stringify(result.data, null, 2)}`, 
                    'error'
                );
            }
        }

        async function testDatabaseRecords() {
            logResult('database-result', 'Checking database records...', 'info');
            
            // Test multiple endpoints to check database state
            const tests = [
                { name: 'Total Cuti Records', endpoint: 'api/cuti?size=1' },
                { name: 'Total Jenis Cuti', endpoint: 'api/jenis-cuti/active' },
                { name: 'Pegawai 16', endpoint: 'api/pegawai/16' }
            ];
            
            let results = [];
            for (const test of tests) {
                const result = await apiCall(test.endpoint);
                results.push({
                    test: test.name,
                    status: result.status,
                    success: result.ok,
                    data: result.data
                });
            }
            
            logResult('database-result', 
                `Database Test Results:\n\n${JSON.stringify(results, null, 2)}`, 
                'info'
            );
        }

        async function testCurrentYearSettings() {
            const pegawaiId = document.getElementById('year-pegawai-id').value;
            logResult('year-settings-result', `Checking current year settings for pegawai ${pegawaiId}...`, 'info');
            
            const currentYear = new Date().getFullYear();
            
            // Test quota for current year
            const quota = await apiCall(`api/pegawai-cuti-quota/${pegawaiId}`);
            
            // Test pegawai details
            const pegawai = await apiCall(`api/pegawai/${pegawaiId}`);
            
            const results = {
                currentYear: currentYear,
                pegawaiExists: pegawai.ok,
                pegawaiData: pegawai.data,
                quotaExists: quota.ok,
                quotaData: quota.data
            };
            
            logResult('year-settings-result', 
                `Current Year Settings:\n\n${JSON.stringify(results, null, 2)}`, 
                'info'
            );
        }

        async function testFullFlow() {
            const pegawaiId = document.getElementById('flow-pegawai-id').value;
            logResult('full-flow-result', 'Running full flow test...', 'info');
            
            const results = {};
            
            // Step 1: Check jenis cuti
            results.step1 = await apiCall('api/jenis-cuti/active');
            
            // Step 2: Check pegawai quota
            results.step2 = await apiCall(`api/pegawai-cuti-quota/${pegawaiId}`);
            
            // Step 3: Submit test cuti
            const formData = new FormData();
            formData.append('pegawaiId', pegawaiId);
            formData.append('tanggalDari', '2025-02-10');
            formData.append('tanggalKe', '2025-02-12');
            formData.append('jenisCuti', '1');
            formData.append('alasanCuti', 'Full flow test cuti');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/cuti/ajukan`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.text();
                results.step3 = {
                    ok: response.ok,
                    status: response.status,
                    data: response.ok ? JSON.parse(data) : data
                };
            } catch (error) {
                results.step3 = { ok: false, error: error.message };
            }
            
            // Step 4: Check history
            results.step4 = await apiCall(`api/cuti/pegawai/${pegawaiId}?page=0&size=5`);
            
            // Step 5: Check admin list
            results.step5 = await apiCall('api/cuti?page=0&size=5');
            
            let summary = `FULL FLOW TEST RESULTS:\n\n`;
            summary += `âœ“ Step 1 - Jenis Cuti: ${results.step1.ok ? 'PASS' : 'FAIL'}\n`;
            summary += `âœ“ Step 2 - Pegawai Quota: ${results.step2.ok ? 'PASS' : 'FAIL'}\n`;
            summary += `âœ“ Step 3 - Submit Cuti: ${results.step3.ok ? 'PASS' : 'FAIL'}\n`;
            summary += `âœ“ Step 4 - History Check: ${results.step4.ok ? 'PASS' : 'FAIL'}\n`;
            summary += `âœ“ Step 5 - Admin List: ${results.step5.ok ? 'PASS' : 'FAIL'}\n\n`;
            summary += `Detailed Results:\n${JSON.stringify(results, null, 2)}`;
            
            const allPassed = Object.values(results).every(r => r.ok);
            logResult('full-flow-result', summary, allPassed ? 'success' : 'error');
        }

        // Auto-load jenis cuti on page load
        window.onload = function() {
            testJenisCutiAPI();
        };
    </script>
</body>
</html>
